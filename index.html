<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ ‚Äî Kanji & Jogo</title>

<style>
:root{
  --bg:#0b0f14;
  --border:#252a36;
  --text:#e6e8ee;
  --muted:#9aa0aa;
  --muted2:#7b8192;

  /* tema din√¢mico (muda com desempenho) */
  --moodHue: 195;          /* base: azul/ciano */
  --accent2: hsl(var(--moodHue) 85% 60%);
  --accent:  hsl(calc(var(--moodHue) - 40) 85% 62%);
  --accent3: hsl(calc(var(--moodHue) + 70) 85% 62%);

  --good:#34d399;
  --bad:#fb7185;
  --warn:#f59e0b;

  --radius:16px;
  --shadow: 0 18px 65px rgba(0,0,0,.45);
}

*{box-sizing:border-box}

body{
  margin:0;
  color:var(--text);
  font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",system-ui,sans-serif;
  line-height:1.95;

  background:
    radial-gradient(1200px 700px at 10% 10%, color-mix(in oklab, var(--accent) 28%, transparent), transparent 55%),
    radial-gradient(900px 600px at 90% 15%, color-mix(in oklab, var(--accent2) 24%, transparent), transparent 55%),
    radial-gradient(900px 650px at 20% 90%, color-mix(in oklab, var(--accent3) 18%, transparent), transparent 55%),
    var(--bg);

  transition: background .6s ease;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  background: rgba(11,15,20,.72);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border-bottom:1px solid var(--border);
}

.topbar{
  max-width:1150px;
  margin:auto;
  padding:18px 18px 12px;
  display:flex;
  gap:18px;
  align-items:flex-start;
  justify-content:space-between;
  flex-wrap:wrap;
}

.brand{min-width:280px;}
.brand .t{
  font-size:20px;
  font-weight:900;
  letter-spacing:1.4px;
}
.brand .s{
  margin-top:6px;
  color:var(--muted);
  font-size:13px;
}
.brand .s b{ color:var(--text); }

nav{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
}

.tabbtn{
  cursor:pointer;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color:var(--muted);
  padding:9px 12px;
  border-radius:999px;
  font-size:13px;
  user-select:none;
  transition: transform .08s ease, background .2s ease, color .2s ease, border-color .2s ease;
  box-shadow: var(--shadow);
}
.tabbtn:active{ transform: translateY(1px); }
.tabbtn.active{
  color:var(--text);
  border-color: color-mix(in oklab, var(--accent2) 45%, transparent);
  background: linear-gradient(90deg,
    color-mix(in oklab, var(--accent) 18%, transparent),
    color-mix(in oklab, var(--accent2) 14%, transparent),
    color-mix(in oklab, var(--accent3) 12%, transparent)
  );
}

.container{
  max-width:1150px;
  margin:auto;
  padding:34px 18px 90px;
}

.section{ display:none; }
.section.active{ display:block; }

.grid{
  display:grid;
  grid-template-columns: 1.15fr .85fr;
  gap:16px;
}
@media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

.panel{
  background: rgba(255,255,255,.06);
  border:1px solid var(--border);
  border-radius:22px;
  padding:16px;
  box-shadow: var(--shadow);
}

.panel h2{
  margin: 0 0 8px;
  font-size: 15px;
  letter-spacing:.6px;
}

.hint{
  color:var(--muted);
  font-size:13px;
  margin-top:0;
}

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}

.toggle{
  display:flex;
  align-items:center;
  gap:8px;
  color:var(--muted);
  font-size:12px;
  user-select:none;
}
.toggle input{ transform: translateY(1px); }

select{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color: var(--text);
  outline:none;
}

.btn{
  cursor:pointer;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color:var(--text);
  padding:8px 10px;
  border-radius:12px;
  font-size:12px;
  user-select:none;
  transition: transform .08s ease, border-color .2s ease;
}
.btn:active{ transform: translateY(1px); }
.btn.primary{
  border-color: color-mix(in oklab, var(--accent2) 55%, transparent);
  background: color-mix(in oklab, var(--accent2) 14%, transparent);
}
.btn.good{
  border-color: color-mix(in oklab, var(--good) 55%, transparent);
  background: color-mix(in oklab, var(--good) 12%, transparent);
}
.btn.danger{
  border-color: color-mix(in oklab, var(--bad) 55%, transparent);
  background: color-mix(in oklab, var(--bad) 10%, transparent);
}
.btn.warn{
  border-color: color-mix(in oklab, var(--warn) 55%, transparent);
  background: color-mix(in oklab, var(--warn) 10%, transparent);
}

.card{
  background: rgba(255,255,255,.07);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding:16px;
  margin-top:12px;
}

.jp{
  font-size:22px;
  font-weight:900;
  letter-spacing:.5px;
  color:var(--accent2);
}
.hira{
  margin-top:6px;
  color:var(--muted);
  font-size:13px;
}
.mean{
  margin-top:8px;
  font-size:14px;
  color:var(--text);
  font-weight:600;
}

.badges{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
.badge{
  font-size:11px;
  border:1px solid var(--border);
  padding:3px 8px;
  border-radius:999px;
  color:var(--muted);
}
.badge.n5{
  border-color: color-mix(in oklab, var(--good) 45%, transparent);
  color: color-mix(in oklab, var(--good) 90%, white);
}
.badge.tag{
  border-color: color-mix(in oklab, var(--accent2) 45%, transparent);
  color: var(--accent2);
}
.badge.warn{
  border-color: color-mix(in oklab, var(--warn) 55%, transparent);
  color: color-mix(in oklab, var(--warn) 95%, white);
}

.kanjigrid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(92px, 1fr));
  gap:12px;
  margin-top:12px;
}
.kanjiitem{
  background: rgba(255,255,255,.06);
  border:1px solid var(--border);
  border-radius: 16px;
  padding:12px 10px;
  text-align:center;
  cursor:pointer;
  transition: transform .12s ease, border-color .2s ease;
}
.kanjiitem:hover{
  transform: translateY(-1px);
  border-color: color-mix(in oklab, var(--accent2) 35%, transparent);
}
.kanjiitem .k{
  font-size:28px;
  font-weight:900;
  color:var(--accent2);
}
.kanjiitem .lvl{
  margin-top:6px;
  font-size:11px;
  color:var(--muted);
}
.kanjiitem .lvl b{ color:var(--text); }

.strokeBox{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  overflow:hidden;
  background: rgba(255,255,255,.04);
}
.strokeHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.strokeHead .t{ font-size:13px; color: var(--muted); }
.strokeBody{ padding:12px; }
.strokeBody svg{ width:100%; height:auto; display:block; }
.strokeNote{ color: var(--muted); font-size:12px; margin-top:8px; }

.bigKanji{
  font-size:86px;
  font-weight:900;
  letter-spacing:2px;
  text-align:center;
  color: var(--accent2);
  line-height:1.0;
  margin: 8px 0 6px;
}

hr.sep{
  border:none;
  border-top:1px solid rgba(255,255,255,.08);
  margin:14px 0;
}
.small{
  color:var(--muted);
  font-size:13px;
}
.small b{ color:var(--text); }

.footer{
  text-align:center;
  padding:40px 0 0;
  color:var(--muted);
  font-size:12px;
}

/* Quiz */
.mcGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
}
@media (max-width: 820px){ .mcGrid{ grid-template-columns:1fr; } }

.mcBox{
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  padding:12px;
  background: rgba(255,255,255,.04);
}
.mcBox h3{
  margin:0 0 8px;
  font-size:13px;
  color:var(--muted);
  letter-spacing:.6px;
}

.choiceList{ display:grid; gap:8px; }
.choiceBtn{
  text-align:left;
  padding:10px 10px;
  border-radius:14px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color: var(--text);
  cursor:pointer;
  transition: transform .08s ease, border-color .2s ease, background .2s ease;
}
.choiceBtn:hover{ transform: translateY(-1px); border-color: color-mix(in oklab, var(--accent2) 25%, transparent); }
.choiceBtn.correct{
  border-color: color-mix(in oklab, var(--good) 60%, transparent);
  background: color-mix(in oklab, var(--good) 14%, transparent);
}
.choiceBtn.wrong{
  border-color: color-mix(in oklab, var(--bad) 60%, transparent);
  background: color-mix(in oklab, var(--bad) 12%, transparent);
}
.choiceBtn:disabled{ opacity:.92; cursor:not-allowed; }

.timerBarWrap{
  width:100%;
  height:10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  overflow:hidden;
  margin-top:10px;
}
.timerBar{
  height:100%;
  width:100%;
  background: linear-gradient(90deg,
    color-mix(in oklab, var(--accent2) 65%, white),
    color-mix(in oklab, var(--accent) 55%, white),
    color-mix(in oklab, var(--accent3) 45%, white)
  );
  transition: width .12s linear;
}

/* flash visual quando acerta/erra */
.flash{
  position: fixed;
  inset: 0;
  pointer-events: none;
  opacity: 0;
  z-index: 999;
}
.flash.good{ background: radial-gradient(circle at 50% 35%, rgba(52,211,153,.22), transparent 60%); }
.flash.bad{  background: radial-gradient(circle at 50% 35%, rgba(251,113,133,.22), transparent 60%); }
.flash.on{ animation: flash .55s ease-out; }
@keyframes flash{
  0%{ opacity:0; }
  20%{ opacity:1; }
  100%{ opacity:0; }
}
</style>
</head>

<body>
<div id="flash" class="flash"></div>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="t">„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ</div>
      <div class="s">
        Kanji N5 (por enquanto) + Jogo inteligente <b>(muda de cor conforme desempenho)</b>
      </div>
    </div>

    <nav>
      <div class="tabbtn active" id="tab-kanji">üà∂ Kanji</div>
      <div class="tabbtn" id="tab-quiz">üéÆ Jogo</div>
    </nav>
  </div>
</header>

<div class="container">

  <!-- ====================== KANJI ====================== -->
  <section id="kanji" class="section active">
    <div class="grid">
      <div class="panel">
        <h2>Kanji ‚Äî N5 (ordem completa)</h2>
        <p class="hint">Clique num kanji: v√™ leitura/significado + stroke order. Depois treina no Jogo.</p>
        <div class="kanjigrid" id="kanjigrid"></div>
      </div>

      <div class="panel">
        <h2>Detalhe</h2>
        <p class="hint">Selecione um kanji na lista.</p>

        <div id="kanjiDetail" class="card" style="display:none;">
          <div class="jp" id="kdKanji"></div>
          <div class="hira" id="kdReadings"></div>
          <div class="mean" id="kdMean"></div>
          <div class="badges" id="kdBadges"></div>

          <div class="strokeBox">
            <div class="strokeHead">
              <div class="t">Ordem dos tra√ßos (Stroke order)</div>
              <div class="btn" id="kdReloadStroke">Recarregar</div>
            </div>
            <div class="strokeBody" id="kdStroke"></div>
            <div class="strokeNote">Carregado online (KanjiVG). Se falhar: Ctrl+F5.</div>
          </div>

          <hr class="sep">
          <div class="row">
            <div class="btn primary" id="kdTrain">Treinar este kanji no Jogo</div>
          </div>
        </div>

        <div id="kanjiDetailEmpty" class="card">
          <div class="mean" style="color:var(--muted);">Clique em um kanji para ver detalhes aqui.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====================== QUIZ ====================== -->
  <section id="quiz" class="section">
    <div class="grid">
      <div class="panel">
        <div class="row">
          <div>
            <h2>Jogo ‚Äî m√∫ltipla escolha + timer</h2>
            <p class="hint">Acerta 2/2 (Leitura + Significado). O tema fica mais ‚Äúverde‚Äù conforme voc√™ melhora.</p>
          </div>

          <div class="row">
            <label class="toggle" title="Repete mais os kanji que voc√™ erra (melhor fixa√ß√£o).">
              <input type="checkbox" id="quizSmart" checked />
              modo inteligente
            </label>
          </div>
        </div>

        <div class="card">
          <div class="row" style="align-items:flex-end;">
            <div style="flex:1;">
              <div class="bigKanji" id="quizKanji">‰∏Ä</div>
              <div class="badges" style="justify-content:center;">
                <span class="badge" id="quizScore">Acertos: 0 ¬∑ Erros: 0 ¬∑ Streak: 0</span>
                <span class="badge warn" id="quizTimerText">‚è±Ô∏è 12s</span>
                <span class="badge tag" id="quizMoodText">Mood: ‚Äî</span>
              </div>
              <div class="timerBarWrap">
                <div class="timerBar" id="timerBar"></div>
              </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <div class="small">Tempo</div>
              <select id="quizTime">
                <option value="8">8s</option>
                <option value="12" selected>12s</option>
                <option value="18">18s</option>
                <option value="25">25s</option>
              </select>
              <div class="btn good" id="quizStart">Start</div>
              <div class="btn" id="quizPause">Pausar</div>
              <div class="btn warn" id="quizNext">Pr√≥ximo</div>
              <div class="btn danger" id="quizReset">Zerar sess√£o</div>
            </div>
          </div>

          <hr class="sep">

          <div class="mcGrid">
            <div class="mcBox">
              <h3>Leituras (escolha 1)</h3>
              <div class="choiceList" id="readingChoices"></div>
            </div>

            <div class="mcBox">
              <h3>Significados (PT-BR) (escolha 1)</h3>
              <div class="choiceList" id="meaningChoices"></div>
            </div>
          </div>

          <div id="quizFeedback" class="card" style="display:none;">
            <div class="mean" id="quizFeedbackTitle"></div>
            <div class="hira" id="quizFeedbackDetail"></div>

            <div class="strokeBox" style="margin-top:12px;">
              <div class="strokeHead">
                <div class="t">Ordem dos tra√ßos (Stroke order)</div>
                <div class="btn" id="quizReloadStroke">Recarregar</div>
              </div>
              <div class="strokeBody" id="quizStroke"></div>
              <div class="strokeNote">Carregado online (KanjiVG).</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Ranking + Estat√≠sticas (local)</h2>
        <p class="hint">Salva no seu navegador (localStorage). Se limpar cache, some.</p>

        <div class="card">
          <div class="mean">üèÜ Melhores marcas</div>
          <div class="small" id="bestStats">‚Äî</div>

          <hr class="sep">
          <div class="mean">üìä Top kanji mais errados</div>
          <div class="small" id="worstKanjis">‚Äî</div>

          <hr class="sep">
          <div class="row">
            <div class="btn danger" id="resetHistory">Resetar hist√≥rico (ranking/erros)</div>
            <div class="btn primary" id="goKanji">Voltar ao Kanji</div>
          </div>

          <hr class="sep">
          <div class="small">
            <b>Como o ‚Äúmood‚Äù funciona:</b><br>
            ‚Ä¢ Ele usa seus √∫ltimos resultados (janela de 12).<br>
            ‚Ä¢ Mais acertos = tema mais verde / menos = mais vermelho.<br>
            ‚Ä¢ Cada acerto/erro d√° um flash visual (verde/vermelho).
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="footer">„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ ¬© 2025</div>
</div>

<script>
/* =========================
   DADOS (N5)
   ========================= */
const KANJI_ORDER_N5 = [
  "‰∏Ä","‰∏É","‰∏á","‰∏â","‰∏ä","‰∏ã","‰∏≠","‰πù","‰∫å","‰∫î","‰∫∫","‰ªä","‰ºë","‰Ωï","ÂÖà","ÂÖ•","ÂÖ´","ÂÖ≠","ÂÜÜ","Âá∫","ÂàÜ","Ââç","Âåó","ÂçÅ","ÂçÉ","Âçà","Âçä","Âçó","Âèã","Âè≥","Âêç","Âõõ","ÂõΩ","Âúü","Â§ñ","Â§ß","Â§©","Â•≥","Â≠ê","Â≠¶","Â∞è","Â±±","Â∑ù","Â∑¶","Âπ¥","Âæå","Êó•","ÊôÇ","Êõ∏","Êúà","Êú®","Êú¨","Êù•","Êù±","Ê†°","ÊØç","ÊØé","Ê∞ó","Ê∞¥","ÁÅ´","Áà∂","Áîü","Áî∑","ÁôΩ","Áôæ","ËÅû","Ë°å","Ë•ø","Ë¶ã","Ë©±","Ë™û","Ë™≠","Ëªä","Èáë","Èï∑","Èñì","Èõ®","Èõª","È£ü","È´ò"
];

const KANJI_INFO = {
  "‰∏Ä":{lvl:"N5", readings:["„ÅÑ„Å°","„Å≤„Å®"], meanings:["um","1"]},
  "‰∏É":{lvl:"N5", readings:["„Åó„Å°","„Å™„Å™"], meanings:["sete","7"]},
  "‰∏á":{lvl:"N5", readings:["„Åæ„Çì"], meanings:["dez mil","10000","10 mil"]},
  "‰∏â":{lvl:"N5", readings:["„Åï„Çì","„Åø„Å£"], meanings:["tr√™s","3"]},
  "‰∏ä":{lvl:"N5", readings:["„Åò„Çá„ÅÜ","„ÅÜ„Åà","„ÅÇ"], meanings:["cima","acima","superior"]},
  "‰∏ã":{lvl:"N5", readings:["„Åã","„Åó„Åü","„Åï"], meanings:["baixo","abaixo","inferior"]},
  "‰∏≠":{lvl:"N5", readings:["„Å°„ÇÖ„ÅÜ","„Å™„Åã"], meanings:["meio","dentro","centro"]},
  "‰πù":{lvl:"N5", readings:["„Åç„ÇÖ„ÅÜ","„Åì„Åì„ÅÆ"], meanings:["nove","9"]},
  "‰∫å":{lvl:"N5", readings:["„Å´","„Åµ„Åü"], meanings:["dois","2"]},
  "‰∫î":{lvl:"N5", readings:["„Åî","„ÅÑ„Å§"], meanings:["cinco","5"]},
  "‰∫∫":{lvl:"N5", readings:["„Åò„Çì","„Å´„Çì","„Å≤„Å®"], meanings:["pessoa","gente","humano"]},
  "‰ªä":{lvl:"N5", readings:["„Åì„Çì","„ÅÑ„Åæ"], meanings:["agora","atualmente"]},
  "‰ºë":{lvl:"N5", readings:["„Åç„ÇÖ„ÅÜ","„ÇÑ„Åô"], meanings:["descansar","folga","feriado","pausa"]},
  "‰Ωï":{lvl:"N5", readings:["„Å™„Çì","„Å™„Å´"], meanings:["o que","qual"]},
  "ÂÖà":{lvl:"N5", readings:["„Åõ„Çì","„Åï„Åç"], meanings:["antes","anterior","frente","ponta"]},
  "ÂÖ•":{lvl:"N5", readings:["„Å´„ÇÖ„ÅÜ","„ÅÑ"], meanings:["entrar","entrada","inserir"]},
  "ÂÖ´":{lvl:"N5", readings:["„ÅØ„Å°","„ÇÑ"], meanings:["oito","8"]},
  "ÂÖ≠":{lvl:"N5", readings:["„Çç„Åè","„ÇÄ"], meanings:["seis","6"]},
  "ÂÜÜ":{lvl:"N5", readings:["„Åà„Çì"], meanings:["iene","yen","c√≠rculo"]},
  "Âá∫":{lvl:"N5", readings:["„Åó„ÇÖ„Å§","„Åß","„Å†"], meanings:["sair","sa√≠da","aparecer","tirar"]},
  "ÂàÜ":{lvl:"N5", readings:["„Å∂„Çì","„Åµ„Çì","„Çè"], meanings:["minuto","parte","entender"]},
  "Ââç":{lvl:"N5", readings:["„Åú„Çì","„Åæ„Åà"], meanings:["antes","frente","anterior"]},
  "Âåó":{lvl:"N5", readings:["„Åª„Åè","„Åç„Åü"], meanings:["norte"]},
  "ÂçÅ":{lvl:"N5", readings:["„Åò„ÇÖ„ÅÜ","„Å®„Åä"], meanings:["dez","10"]},
  "ÂçÉ":{lvl:"N5", readings:["„Åõ„Çì","„Å°"], meanings:["mil","1000"]},
  "Âçà":{lvl:"N5", readings:["„Åî"], meanings:["meio-dia","am/pm"]},
  "Âçä":{lvl:"N5", readings:["„ÅØ„Çì"], meanings:["metade","meia"]},
  "Âçó":{lvl:"N5", readings:["„Å™„Çì","„Åø„Å™„Åø"], meanings:["sul"]},
  "Âèã":{lvl:"N5", readings:["„ÇÜ„ÅÜ","„Å®„ÇÇ"], meanings:["amigo"]},
  "Âè≥":{lvl:"N5", readings:["„ÅÜ","„Åø„Åé"], meanings:["direita"]},
  "Âêç":{lvl:"N5", readings:["„ÇÅ„ÅÑ","„Å™"], meanings:["nome","fama"]},
  "Âõõ":{lvl:"N5", readings:["„Åó","„Çà„Çì","„Çà"], meanings:["quatro","4"]},
  "ÂõΩ":{lvl:"N5", readings:["„Åì„Åè","„Åè„Å´"], meanings:["pa√≠s","na√ß√£o"]},
  "Âúü":{lvl:"N5", readings:["„Å©","„Å§„Å°"], meanings:["terra","solo","s√°bado"]},
  "Â§ñ":{lvl:"N5", readings:["„Åå„ÅÑ","„Åù„Å®","„ÅØ„Åö"], meanings:["fora","exterior"]},
  "Â§ß":{lvl:"N5", readings:["„Å†„ÅÑ","„Åä„Åä"], meanings:["grande"]},
  "Â§©":{lvl:"N5", readings:["„Å¶„Çì","„ÅÇ„Åæ"], meanings:["c√©u"]},
  "Â•≥":{lvl:"N5", readings:["„Åò„Çá","„Åä„Çì„Å™"], meanings:["mulher","feminino"]},
  "Â≠ê":{lvl:"N5", readings:["„Åó","„Åì"], meanings:["crian√ßa","filho"]},
  "Â≠¶":{lvl:"N5", readings:["„Åå„Åè","„Åæ„Å™"], meanings:["estudo","aprender","escola"]},
  "Â∞è":{lvl:"N5", readings:["„Åó„Çá„ÅÜ","„Å°„ÅÑ"], meanings:["pequeno"]},
  "Â±±":{lvl:"N5", readings:["„Åï„Çì","„ÇÑ„Åæ"], meanings:["montanha"]},
  "Â∑ù":{lvl:"N5", readings:["„Åõ„Çì","„Åã„Çè"], meanings:["rio"]},
  "Â∑¶":{lvl:"N5", readings:["„Åï","„Å≤„Å†„Çä"], meanings:["esquerda"]},
  "Âπ¥":{lvl:"N5", readings:["„Å≠„Çì","„Å®„Åó"], meanings:["ano"]},
  "Âæå":{lvl:"N5", readings:["„Åî","„ÅÆ„Å°","„ÅÜ„Åó"], meanings:["depois","atr√°s"]},
  "Êó•":{lvl:"N5", readings:["„Å´„Å°","„Åò„Å§","„Å≤"], meanings:["dia","sol"]},
  "ÊôÇ":{lvl:"N5", readings:["„Åò","„Å®„Åç"], meanings:["hora","tempo"]},
  "Êõ∏":{lvl:"N5", readings:["„Åó„Çá","„Åã"], meanings:["escrever","livro"]},
  "Êúà":{lvl:"N5", readings:["„Åí„Å§","„Åå„Å§","„Å§„Åç"], meanings:["m√™s","lua"]},
  "Êú®":{lvl:"N5", readings:["„ÇÇ„Åè","„Åº„Åè","„Åç"], meanings:["√°rvore","madeira"]},
  "Êú¨":{lvl:"N5", readings:["„Åª„Çì","„ÇÇ„Å®"], meanings:["livro","origem"]},
  "Êù•":{lvl:"N5", readings:["„Çâ„ÅÑ","„Åè","„Åì"], meanings:["vir","pr√≥ximo"]},
  "Êù±":{lvl:"N5", readings:["„Å®„ÅÜ","„Å≤„Åå„Åó"], meanings:["leste"]},
  "Ê†°":{lvl:"N5", readings:["„Åì„ÅÜ"], meanings:["escola"]},
  "ÊØç":{lvl:"N5", readings:["„Åº","„ÅØ„ÅØ"], meanings:["m√£e"]},
  "ÊØé":{lvl:"N5", readings:["„Åæ„ÅÑ"], meanings:["todo","cada"]},
  "Ê∞ó":{lvl:"N5", readings:["„Åç","„Åë"], meanings:["energia","ar","esp√≠rito","clima","humor"]},
  "Ê∞¥":{lvl:"N5", readings:["„Åô„ÅÑ","„Åø„Åö"], meanings:["√°gua","quarta"]},
  "ÁÅ´":{lvl:"N5", readings:["„Åã","„Å≤"], meanings:["fogo","ter√ßa"]},
  "Áà∂":{lvl:"N5", readings:["„Åµ","„Å°„Å°"], meanings:["pai"]},
  "Áîü":{lvl:"N5", readings:["„Åõ„ÅÑ","„Åó„Çá„ÅÜ","„ÅÑ","„ÅÜ","„Å™„Åæ"], meanings:["vida","nascer","cru","aluno"]},
  "Áî∑":{lvl:"N5", readings:["„Å†„Çì","„Åä„Å®„Åì"], meanings:["homem","masculino"]},
  "ÁôΩ":{lvl:"N5", readings:["„ÅØ„Åè","„Åó„Çç"], meanings:["branco"]},
  "Áôæ":{lvl:"N5", readings:["„Å≤„ÇÉ„Åè"], meanings:["cem","100"]},
  "ËÅû":{lvl:"N5", readings:["„Å∂„Çì","„ÇÇ„Çì","„Åç"], meanings:["ouvir","perguntar"]},
  "Ë°å":{lvl:"N5", readings:["„Åì„ÅÜ","„Åé„Çá„ÅÜ","„ÅÑ","„ÇÜ"], meanings:["ir","linha","fazer"]},
  "Ë•ø":{lvl:"N5", readings:["„Åõ„ÅÑ","„Å´„Åó"], meanings:["oeste"]},
  "Ë¶ã":{lvl:"N5", readings:["„Åë„Çì","„Åø"], meanings:["ver","olhar","assistir"]},
  "Ë©±":{lvl:"N5", readings:["„Çè","„ÅØ„Å™"], meanings:["falar","conversa","hist√≥ria"]},
  "Ë™û":{lvl:"N5", readings:["„Åî","„Åã„Åü"], meanings:["l√≠ngua","idioma","palavra"]},
  "Ë™≠":{lvl:"N5", readings:["„Å©„Åè","„Çà"], meanings:["ler"]},
  "Ëªä":{lvl:"N5", readings:["„Åó„ÇÉ","„Åè„Çã„Åæ"], meanings:["carro","ve√≠culo"]},
  "Èáë":{lvl:"N5", readings:["„Åç„Çì","„Åã„Å≠"], meanings:["dinheiro","ouro","sexta"]},
  "Èï∑":{lvl:"N5", readings:["„Å°„Çá„ÅÜ","„Å™„Åå"], meanings:["longo","chefe"]},
  "Èñì":{lvl:"N5", readings:["„Åã„Çì","„Åë„Çì","„ÅÇ„ÅÑ„Å†","„Åæ"], meanings:["entre","intervalo","tempo"]},
  "Èõ®":{lvl:"N5", readings:["„ÅÜ","„ÅÇ„ÇÅ"], meanings:["chuva"]},
  "Èõª":{lvl:"N5", readings:["„Åß„Çì"], meanings:["eletricidade"]},
  "È£ü":{lvl:"N5", readings:["„Åó„Çá„Åè","„Åü"], meanings:["comer","comida"]},
  "È´ò":{lvl:"N5", readings:["„Åì„ÅÜ","„Åü„Åã"], meanings:["alto","caro"]}
};

/* =========================
   HELPERS
   ========================= */
const $ = (id)=>document.getElementById(id);

function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function uniqByText(opts){
  const seen = new Set();
  const out = [];
  for(const o of opts){
    if(seen.has(o.text)) continue;
    seen.add(o.text);
    out.push(o);
  }
  return out;
}

function flash(type){
  const f = $("flash");
  f.className = "flash " + type;
  // reinicia anima√ß√£o
  void f.offsetWidth;
  f.classList.add("on");
  setTimeout(()=>f.classList.remove("on"), 560);
}

/* =========================
   TABS
   ========================= */
const sections = { kanji:$("kanji"), quiz:$("quiz") };
const tabs = { kanji:$("tab-kanji"), quiz:$("tab-quiz") };

function openTab(id){
  Object.values(sections).forEach(s=>s.classList.remove("active"));
  Object.values(tabs).forEach(t=>t.classList.remove("active"));
  sections[id].classList.add("active");
  tabs[id].classList.add("active");
  if(id==="kanji") renderKanjiGrid();
}

tabs.kanji.addEventListener("click", ()=>openTab("kanji"));
tabs.quiz.addEventListener("click", ()=>openTab("quiz"));

/* =========================
   STROKE ORDER (KanjiVG) + CACHE
   ========================= */
const svgCache = new Map();

function codepointHex5(ch){
  return ch.codePointAt(0).toString(16).padStart(5,"0");
}

async function loadKanjiStrokeSVG(kanji, targetEl){
  if(svgCache.has(kanji)){
    targetEl.innerHTML = svgCache.get(kanji);
    return;
  }

  const hex = codepointHex5(kanji);
  const url = `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}.svg`;
  targetEl.innerHTML = `<div class="small">Carregando stroke order...</div>`;

  try{
    const res = await fetch(url, {cache:"force-cache"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const svgText = await res.text();

    // limpa width/height e xml header pra responsivo
    const cleaned = svgText
      .replace(/width="[^"]*"/g,'')
      .replace(/height="[^"]*"/g,'')
      .replace(/<\?xml[^>]*\?>/g,'');

    svgCache.set(kanji, cleaned);
    targetEl.innerHTML = cleaned;
  }catch{
    targetEl.innerHTML = `<div class="small">Falha ao carregar agora. Ctrl+F5 e tente novamente.</div>`;
  }
}

/* =========================
   KANJI TAB
   ========================= */
const kanjigrid = $("kanjigrid");
const kdBox = $("kanjiDetail");
const kdEmpty = $("kanjiDetailEmpty");
const kdKanji = $("kdKanji");
const kdReadings = $("kdReadings");
const kdMean = $("kdMean");
const kdBadges = $("kdBadges");
const kdStroke = $("kdStroke");
let selectedKanji = null;

function renderKanjiGrid(){
  if(kanjigrid.dataset.rendered === "1") return; // otimiza: s√≥ renderiza 1x
  kanjigrid.dataset.rendered = "1";

  const frag = document.createDocumentFragment();
  for(const k of KANJI_ORDER_N5){
    const div = document.createElement("div");
    div.className = "kanjiitem";
    div.innerHTML = `<div class="k">${k}</div><div class="lvl"><b>N5</b> „Éª clique</div>`;
    div.addEventListener("click", ()=>showKanjiDetail(k));
    frag.appendChild(div);
  }
  kanjigrid.appendChild(frag);
}

function showKanjiDetail(k){
  selectedKanji = k;
  const info = KANJI_INFO[k];

  kdEmpty.style.display="none";
  kdBox.style.display="block";

  kdKanji.textContent = k;
  kdReadings.textContent = `Leituras: ${info?.readings?.join(" / ") || "‚Äî"}`;
  kdMean.textContent = `Significado (PT): ${info?.meanings?.join(" / ") || "‚Äî"}`;
  kdBadges.innerHTML = `<span class="badge n5">N5</span><span class="badge tag">kanji</span>`;

  loadKanjiStrokeSVG(k, kdStroke);
}

$("kdReloadStroke").addEventListener("click", ()=>{
  if(selectedKanji) loadKanjiStrokeSVG(selectedKanji, kdStroke);
});

$("kdTrain").addEventListener("click", ()=>{
  if(!selectedKanji) return;
  openTab("quiz");
  setQuestion(selectedKanji, true);
});

/* =========================
   QUIZ: stats + mood
   ========================= */
const LS_KEY = "vampire_znzn_kanji_quiz_v3";

function defaultStats(){
  return {
    bestStreak: 0,
    bestAccuracy: 0,
    bestScore: 0,
    totalCorrect: 0,
    totalWrong: 0,
    perKanji: {},          // { "Êó•": {c,w} }
    recent: []             // √∫ltimos resultados (1/0), janela 12
  };
}

function loadStats(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : defaultStats();
  }catch{
    return defaultStats();
  }
}

function saveStats(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(stats)); }catch{}
}

let stats = loadStats();

function ensurePerKanji(k){
  if(!stats.perKanji[k]) stats.perKanji[k] = {c:0,w:0};
}

function pushRecent(ok){
  stats.recent.push(ok ? 1 : 0);
  if(stats.recent.length > 12) stats.recent.shift();
}

function moodScore(){
  if(!stats.recent.length) return 0.5;
  const sum = stats.recent.reduce((a,b)=>a+b,0);
  return sum / stats.recent.length; // 0..1
}

function applyMood(){
  const s = moodScore(); // 0..1
  // hue 8 (vermelho) -> 135 (verde)
  const hue = Math.round(8 + s * 127);
  document.documentElement.style.setProperty("--moodHue", String(hue));
  $("quizMoodText").textContent = `Mood: ${Math.round(s*100)}%`;
}

/* =========================
   QUIZ: engine
   ========================= */
const quizSmart = $("quizSmart");
const quizKanji = $("quizKanji");
const quizScoreEl = $("quizScore");
const quizTimerText = $("quizTimerText");
const timerBar = $("timerBar");
const quizTime = $("quizTime");
const readingChoices = $("readingChoices");
const meaningChoices = $("meaningChoices");
const quizFeedback = $("quizFeedback");
const quizFeedbackTitle = $("quizFeedbackTitle");
const quizFeedbackDetail = $("quizFeedbackDetail");
const quizStroke = $("quizStroke");
const bestStatsEl = $("bestStats");
const worstKanjisEl = $("worstKanjis");

$("quizReloadStroke").addEventListener("click", ()=>{
  loadKanjiStrokeSVG(quizState.current, quizStroke);
});

$("goKanji").addEventListener("click", ()=>{
  openTab("kanji");
});

$("resetHistory").addEventListener("click", ()=>{
  stats = defaultStats();
  saveStats();
  updateRightPanel();
  applyMood();
  flash("bad"); // feedback visual de reset
});

const quizState = {
  current: "‰∏Ä",
  running: false,
  timerId: null,
  timeLeftMs: 12000,
  timeTotalMs: 12000,

  sessionCorrect: 0,
  sessionWrong: 0,
  sessionStreak: 0,

  answeredReading: false,
  answeredMeaning: false,
  okReading: false,
  okMeaning: false,
};

function updateScoreUI(){
  quizScoreEl.textContent =
    `Acertos: ${quizState.sessionCorrect} ¬∑ Erros: ${quizState.sessionWrong} ¬∑ Streak: ${quizState.sessionStreak}`;
}

function updateRightPanel(){
  // bests
  const totalGlobal = stats.totalCorrect + stats.totalWrong;
  const accGlobal = totalGlobal ? (stats.totalCorrect / totalGlobal) : 0;

  bestStatsEl.innerHTML = `
    ‚Ä¢ Best streak: <b>${stats.bestStreak}</b><br>
    ‚Ä¢ Best accuracy: <b>${Math.round(stats.bestAccuracy*100)}%</b><br>
    ‚Ä¢ Best score (C‚àíE): <b>${stats.bestScore}</b><br>
    ‚Ä¢ Global accuracy: <b>${Math.round(accGlobal*100)}%</b>
      (C:${stats.totalCorrect} / E:${stats.totalWrong})
  `;

  // worst list
  const arr = Object.entries(stats.perKanji).map(([k,v])=>{
    const total = v.c + v.w;
    const err = total ? (v.w / total) : 0;
    return {k, c:v.c, w:v.w, total, err};
  }).filter(x=>x.total>0);

  arr.sort((a,b)=> (b.w - a.w) || (b.err - a.err));
  const top = arr.slice(0,10);

  worstKanjisEl.innerHTML = top.length
    ? top.map(x=>{
        const pct = Math.round(x.err*100);
        return `‚Ä¢ <b>${x.k}</b> ‚Äî erros: ${x.w} / ${x.total} (${pct}%)`;
      }).join("<br>")
    : "‚Äî";
}

function updateBests(){
  stats.bestStreak = Math.max(stats.bestStreak, quizState.sessionStreak);

  const totalSession = quizState.sessionCorrect + quizState.sessionWrong;
  const accSession = totalSession ? (quizState.sessionCorrect / totalSession) : 0;
  const scoreSession = quizState.sessionCorrect - quizState.sessionWrong;

  stats.bestAccuracy = Math.max(stats.bestAccuracy, accSession);
  stats.bestScore = Math.max(stats.bestScore, scoreSession);
}

function makeReadingText(k){
  return (KANJI_INFO[k]?.readings || ["‚Äî"]).join(" / ");
}
function makeMeaningText(k){
  return (KANJI_INFO[k]?.meanings || ["‚Äî"]).join(" / ");
}

function buildChoices(kind, correctKanji){
  const pool = KANJI_ORDER_N5.filter(k => k !== correctKanji);
  const distractors = shuffle(pool).slice(0, 12);

  const correctText = (kind==="reading") ? makeReadingText(correctKanji) : makeMeaningText(correctKanji);
  const correct = { text: correctText, correct: true };

  let opts = [correct, ...distractors.map(k=>{
    const text = (kind==="reading") ? makeReadingText(k) : makeMeaningText(k);
    return { text, correct:false };
  })];

  opts = uniqByText(opts);
  if(!opts.some(o=>o.correct)) opts.unshift(correct);

  opts = opts.slice(0,4);
  while(opts.length < 4){
    const k = pool[Math.floor(Math.random()*pool.length)];
    const text = (kind==="reading") ? makeReadingText(k) : makeMeaningText(k);
    if(opts.some(o=>o.text===text)) continue;
    opts.push({text, correct:false});
  }
  return shuffle(opts);
}

function resetQuestionState(){
  quizState.answeredReading = false;
  quizState.answeredMeaning = false;
  quizState.okReading = false;
  quizState.okMeaning = false;
  quizFeedback.style.display = "none";
}

function disableAllChoices(){
  document.querySelectorAll(".choiceBtn").forEach(b=> b.disabled = true);
}

function renderChoiceButtons(targetEl, options, onPick){
  targetEl.innerHTML = "";
  for(const opt of options){
    const b = document.createElement("button");
    b.type="button";
    b.className="choiceBtn";
    b.textContent = opt.text;

    b.addEventListener("click", ()=>{
      // desabilita s√≥ esse bloco
      const btns = Array.from(targetEl.querySelectorAll(".choiceBtn"));
      btns.forEach(btn=> btn.disabled = true);

      // pinta corretos
      btns.forEach((btn, idx)=>{
        if(options[idx].correct) btn.classList.add("correct");
      });

      if(opt.correct) b.classList.add("correct");
      else b.classList.add("wrong");

      onPick(opt.correct);
    });

    targetEl.appendChild(b);
  }
}

function weightedPick(pool){
  // peso maior para mais erros / menos acertos
  let total = 0;
  const weights = pool.map(k=>{
    ensurePerKanji(k);
    const {c,w} = stats.perKanji[k];
    const unseen = (c+w===0) ? 0.8 : 0;
    const weight = Math.max(0.2, 1 + w*2.2 - c*0.35 + unseen);
    total += weight;
    return weight;
  });

  let r = Math.random() * total;
  for(let i=0;i<pool.length;i++){
    r -= weights[i];
    if(r <= 0) return pool[i];
  }
  return pool[pool.length-1];
}

function pickKanji(){
  const pool = KANJI_ORDER_N5;
  return quizSmart.checked ? weightedPick(pool) : pool[Math.floor(Math.random()*pool.length)];
}

function setQuestion(kanji, keepTimerRunning){
  quizState.current = kanji;
  quizKanji.textContent = kanji;

  resetQuestionState();

  const rOpts = buildChoices("reading", kanji);
  const mOpts = buildChoices("meaning", kanji);

  renderChoiceButtons(readingChoices, rOpts, (ok)=>{
    quizState.answeredReading = true;
    quizState.okReading = ok;
    evaluateIfComplete();
  });

  renderChoiceButtons(meaningChoices, mOpts, (ok)=>{
    quizState.answeredMeaning = true;
    quizState.okMeaning = ok;
    evaluateIfComplete();
  });

  // Timer
  if(quizState.running){
    startTimer(true);
  }else if(!keepTimerRunning){
    const seconds = Number(quizTime.value);
    quizState.timeTotalMs = seconds * 1000;
    quizState.timeLeftMs = quizState.timeTotalMs;
    updateTimerUI();
  }
}

function nextQuestion(){
  setQuestion(pickKanji(), true);
}

function showFeedback(scored, okAll){
  const k = quizState.current;
  const info = KANJI_INFO[k];
  const r = info ? info.readings.join(" / ") : "‚Äî";
  const m = info ? info.meanings.join(" / ") : "‚Äî";

  quizFeedback.style.display = "block";
  quizFeedbackTitle.innerHTML = scored
    ? (okAll ? `‚úÖ <b>Acertou!</b> (2/2)` : `‚ùå <b>Errou.</b>`)
    : `üëÅÔ∏è <b>Revelado</b>`;

  quizFeedbackDetail.innerHTML = `
    Kanji: <b>${k}</b><br>
    Leituras: <b>${r}</b><br>
    Significados: <b>${m}</b>
  `;

  loadKanjiStrokeSVG(k, quizStroke);
}

function commitResult(okAll, reason){
  // reason: "answered" | "timeout"
  const k = quizState.current;
  ensurePerKanji(k);

  if(okAll){
    quizState.sessionCorrect += 1;
    quizState.sessionStreak += 1;

    stats.totalCorrect += 1;
    stats.perKanji[k].c += 1;
    pushRecent(true);

    flash("good");
  }else{
    quizState.sessionWrong += 1;
    quizState.sessionStreak = 0;

    stats.totalWrong += 1;
    stats.perKanji[k].w += 1;
    pushRecent(false);

    flash("bad");
  }

  updateScoreUI();
  updateBests();
  applyMood();
  updateRightPanel();
  saveStats();

  showFeedback(true, okAll);

  stopTimer();
  // avan√ßa r√°pido
  setTimeout(()=> nextQuestion(), 850);
}

function evaluateIfComplete(){
  if(!(quizState.answeredReading && quizState.answeredMeaning)) return;
  const okAll = quizState.okReading && quizState.okMeaning;
  commitResult(okAll, "answered");
}

/* =========================
   TIMER (1 intervalo, nunca duplica)
   ========================= */
function updateTimerUI(){
  const leftSec = Math.max(0, Math.ceil(quizState.timeLeftMs/1000));
  quizTimerText.textContent = `‚è±Ô∏è ${leftSec}s`;

  const pct = quizState.timeTotalMs ? (quizState.timeLeftMs/quizState.timeTotalMs) : 0;
  timerBar.style.width = `${Math.max(0, Math.min(1, pct))*100}%`;
}

function stopTimer(){
  if(quizState.timerId){
    clearInterval(quizState.timerId);
    quizState.timerId = null;
  }
  quizState.running = false;
}

function startTimer(reset){
  const seconds = Number(quizTime.value);
  quizState.timeTotalMs = seconds*1000;
  if(reset) quizState.timeLeftMs = quizState.timeTotalMs;

  stopTimer();          // mata qualquer loop anterior
  quizState.running = true;

  quizState.timerId = setInterval(()=>{
    quizState.timeLeftMs -= 200;
    updateTimerUI();

    if(quizState.timeLeftMs <= 0){
      stopTimer();
      disableAllChoices();

      // timeout = erro (1 vez) e avan√ßa
      commitResult(false, "timeout");
    }
  }, 200);

  updateTimerUI();
}

/* =========================
   CONTROLES QUIZ
   ========================= */
$("quizStart").addEventListener("click", ()=> startTimer(true));
$("quizPause").addEventListener("click", ()=>{
  if(quizState.running) stopTimer();
  else startTimer(false);
});
$("quizNext").addEventListener("click", ()=> nextQuestion());
$("quizReset").addEventListener("click", ()=>{
  stopTimer();
  quizState.sessionCorrect = 0;
  quizState.sessionWrong = 0;
  quizState.sessionStreak = 0;
  updateScoreUI();
  flash("bad");
  nextQuestion();
});
quizTime.addEventListener("change", ()=>{
  if(quizState.running) startTimer(true);
  else{
    quizState.timeTotalMs = Number(quizTime.value)*1000;
    quizState.timeLeftMs = quizState.timeTotalMs;
    updateTimerUI();
  }
});

/* =========================
   INIT
   ========================= */
renderKanjiGrid();
updateRightPanel();
applyMood();
updateScoreUI();
setQuestion("‰∏Ä", false);
</script>

</body>
</html>
